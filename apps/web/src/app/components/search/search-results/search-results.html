<div class="search-results-container">
  <!-- Loading State -->
  <app-loading-spinner 
    *ngIf="isLoading && results.length === 0"
    message="Searching for answers..."
    subMessage="This may take a few seconds"
    variant="dots">
  </app-loading-spinner>

  <!-- Skeleton Loading for Results -->
  <app-skeleton-loader 
    *ngIf="isLoading && results.length === 0"
    type="search-result"
    [count]="3"
    [showHeader]="true"
    [showActions]="true"
    [showReferences]="true">
  </app-skeleton-loader>

  <!-- AI Answer Results with Tabs -->
  <div class="ai-results-list" *ngIf="!isLoading && results.length > 0">
    <div 
      class="ai-result-item" 
      *ngFor="let result of results; trackBy: trackByResult; let i = index">
      
      <!-- AI Answer Header -->
      <!-- Removed empty header div to eliminate blank space -->

      <!-- Tab System -->
      <app-tab-container
        *ngIf="result.references && result.references.length > 0; else answerOnly"
        [tabs]="getTabsForResult(result)"
        [activeTab]="activeTab"
        (tabChange)="onTabChange($event)">
        
        <app-tab-panel tabId="answer" [activeTab]="activeTab">
          <!-- Top Sources (Limited to 4) -->
          <div class="top-sources-container" *ngIf="result.references && result.references.length > 0">
            <div class="sources-grid">
              <app-source-card
                *ngFor="let reference of result.references.slice(0, 4); trackBy: trackByReference"
                [source]="reference"
                variant="compact"
                (sourceClick)="onReferenceClick($event)">
              </app-source-card>
            </div>
          </div>

          <!-- AI Answer Content -->
          <div class="ai-answer-content">
            <div class="answer-text" [innerHTML]="formatAnswer(result.answer)"></div>
            
            <!-- Sources Summary -->
            <div class="sources-summary" *ngIf="result.references && result.references.length > 0">
              <app-sources-badge 
                [count]="result.references.length"
                variant="default">
              </app-sources-badge>
            </div>
          </div>

          <!-- Follow-up Questions -->
          <app-follow-up-questions
            *ngIf="result.followUpQuestions && result.followUpQuestions.length > 0"
            [questions]="result.followUpQuestions"
            title="Related questions"
            icon="chat"
            variant="list"
            (questionClick)="onFollowUpClick($event)">
          </app-follow-up-questions>
        </app-tab-panel>

        <app-tab-panel tabId="sources" [activeTab]="activeTab">
          <div class="sources-tab-content">
            <div class="sources-header">
              <h4 class="sources-title">
                <mat-icon>link</mat-icon>
                All Sources ({{ result.references.length }})
              </h4>
            </div>
            
            <div class="sources-list">
              <div 
                class="source-item" 
                *ngFor="let reference of result.references; trackBy: trackByReference; let i = index"
                (click)="onReferenceClick(reference)">
                <div class="source-number">{{ i + 1 }}</div>
                <div class="source-content">
                  <div class="source-title">{{ reference.title }}</div>
                  <div class="source-url">{{ reference.url }}</div>
                  <div class="source-snippet" *ngIf="reference.snippet">{{ reference.snippet }}</div>
                  <div class="source-meta">
                    <span class="source-domain">{{ reference.domain || getDomainFromUrl(reference.url) }}</span>
                    <span class="source-date" *ngIf="reference.publishedDate">{{ reference.publishedDate | date:'MMM d, y' }}</span>
                    <span class="source-relevance">Relevance: {{ reference.relevance }}%</span>
                  </div>
                </div>
                <div class="source-action">
                  <mat-icon>open_in_new</mat-icon>
                </div>
              </div>
            </div>
          </div>
        </app-tab-panel>
      </app-tab-container>

      <!-- Answer Only Template (no sources) -->
      <ng-template #answerOnly>
        <div class="answer-only-content">
          <!-- AI Answer Content -->
          <div class="ai-answer-content">
            <div class="answer-text" [innerHTML]="formatAnswer(result.answer)"></div>
          </div>

          <!-- Follow-up Questions -->
          <app-follow-up-questions
            *ngIf="result.followUpQuestions && result.followUpQuestions.length > 0"
            [questions]="result.followUpQuestions"
            title="Related questions"
            icon="chat"
            variant="list"
            (questionClick)="onFollowUpClick($event)">
          </app-follow-up-questions>
        </div>
      </ng-template>

      <!-- Search Metadata -->
      <div class="search-metadata" *ngIf="result.searchTime">
        <div class="metadata-left">
          <div class="metadata-item">
            <mat-icon>schedule</mat-icon>
            <span>{{ result.searchTime }}s</span>
          </div>
          <div class="metadata-item" *ngIf="result.tokenUsage">
            <mat-icon>memory</mat-icon>
            <span>{{ result.tokenUsage.total }} tokens</span>
          </div>
        </div>
        <div class="ai-answer-actions">
          <button class="action-btn" (click)="onCopyAnswer(result)" title="Copy answer">
            <mat-icon>content_copy</mat-icon>
          </button>
          <button class="action-btn" (click)="onShareAnswer(result)" title="Share answer">
            <mat-icon>share</mat-icon>
          </button>
          <button class="action-btn" (click)="onContinueSearch(result)" title="Continue searching">
            <mat-icon>search</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- No Results -->
  <app-empty-state 
    *ngIf="!isLoading && results.length === 0"
    type="search"
    icon="search"
    title="No results found"
    message="Try adjusting your search terms or ask a different question.">
  </app-empty-state>
</div>
